<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <!-- ضبط العرض ليناسب الأجهزة المحمولة -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>توليد الدعوات المخصصة</title>
  <!-- تضمين Bootstrap مع دعم RTL -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
  <style>
    /* تضمين الخطوط (عند العرض) من ملفات TTF - هذه القواعد تُستخدم أثناء العرض في المتصفح */
    @font-face {
      font-family: 'Madani Arabic Bold';
      src: url('fonts/MadaniArabic-Bold.ttf') format('truetype');
      font-weight: bold;
      font-style: normal;
    }
    @font-face {
      font-family: 'Madani Arabic Light';
      src: url('fonts/MadaniArabic-Light.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    body {
      direction: rtl;
    }

    /* إعداد عرض معاينة الدعوة */
    svg {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      margin: 20px 0;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="text-center mb-4">توليد الدعوات المخصصة</h1>
    <div class="row">
      <!-- العمود الذي يحتوي على حقول الإدخال والزر -->
      <div class="col-lg-6 mb-4">
        <div class="card p-4">
          <div class="mb-3">
            <label for="employeeName" class="form-label">اسم الموظف</label>
            <input type="text" id="employeeName" class="form-control" placeholder="اسم الموظف">
          </div>
          <div class="mb-3">
            <label for="jobTitle" class="form-label">المسمى الوظيفي</label>
            <input type="text" id="jobTitle" class="form-control" placeholder="المسمى الوظيفي">
          </div>
          <div class="d-grid gap-2">
            <!-- زر حفظ التصميم كصورة PNG -->
            <button onclick="downloadImage()" class="btn btn-success">حفظ كصورة PNG</button>
          </div>
        </div>
      </div>
      <!-- العمود الذي يحتوي على معاينة التصميم -->
      <div class="col-lg-6 mb-4">
        <svg id="invitationSvg" viewBox="0 0 1080 1920">
          <!-- الخلفية: تأكد من أن ملف inv.svg موجود في المسار الصحيح -->
          <image id="bgImage" href="inv-1.svg" x="0" y="0" width="1080" height="1920" />
          <!-- مجموعة النصوص مع خصائصها -->
          <g id="textGroup" transform="translate(540,960)">
            <!-- نص اسم الموظف بخط Madani Arabic Bold، حجم 90، ولون #D38054 -->
            <text id="employeeNameText" text-anchor="middle" font-family="Madani Arabic Bold" font-size="70" fill="#D38054" y="440">
              اسم الموظف
            </text>
            <!-- نص المسمى الوظيفي بخط Madani Arabic Light، حجم 53، ولون أسود -->
            <text id="jobTitleText" text-anchor="middle" font-family="Madani Arabic Light" font-size="50" fill="#000" y="340">
              المسمى الوظيفي
            </text>
          </g>
        </svg>
      </div>
    </div>
  </div>
  
  <!-- تضمين Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // تحديث المعاينة فوراً عند إدخال المستخدم
    document.getElementById('employeeName').addEventListener('input', updateInvitation);
    document.getElementById('jobTitle').addEventListener('input', updateInvitation);

    function updateInvitation() {
      const name = document.getElementById('employeeName').value;
      const job = document.getElementById('jobTitle').value;
      document.getElementById('employeeNameText').textContent = name || "اسم الموظف";
      document.getElementById('jobTitleText').textContent = job || "المسمى الوظيفي";
    }

    // الحصول على اسم الملف بناءً على مدخلات المستخدم
    function getFileName() {
      const name = document.getElementById('employeeName').value.trim() || "اسم الموظف";
      const job = document.getElementById('jobTitle').value.trim() || "المسمى الوظيفي";
      return `${name} - ${job}`;
    }

    // تضمين الأنماط المحسوبة لكل عنصر داخل الـ SVG
    function inlineAllComputedStyles(element) {
      const computedStyle = window.getComputedStyle(element);
      let styleString = "";
      for (let i = 0; i < computedStyle.length; i++) {
        const prop = computedStyle[i];
        styleString += `${prop}:${computedStyle.getPropertyValue(prop)};`;
      }
      element.setAttribute("style", styleString);
      Array.from(element.children).forEach(child => inlineAllComputedStyles(child));
    }

    // تحويل الصور الخارجية (مثل الخلفية) إلى Data URL
    async function inlineExternalImages(svgElement) {
      const images = svgElement.querySelectorAll("image");
      for (const imageElement of images) {
        let href = imageElement.getAttribute("href");
        if (href && !href.startsWith("data:")) {
          try {
            const response = await fetch(href);
            const blob = await response.blob();
            const dataUrl = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
            imageElement.setAttribute("href", dataUrl);
          } catch (e) {
            console.error("فشل في تحويل الصورة الخارجية:", e);
          }
        }
      }
    }

    // دالة لتحويل ملف الخط إلى Data URL وإرجاع تعريف الـ @font-face
    async function inlineFont(fontName, fontUrl) {
      try {
        const response = await fetch(fontUrl);
        const blob = await response.blob();
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
        return `@font-face { font-family: '${fontName}'; src: url('${dataUrl}') format('truetype'); }`;
      } catch (error) {
        console.error("خطأ في جلب الخط:", error);
        return "";
      }
    }

    // تضمين تعريفات الخط داخل الـ SVG باستخدام Data URLs
    async function inlineFonts(svgElement) {
      const boldCSS = await inlineFont('Madani Arabic Bold', 'fonts/MadaniArabic-Bold.ttf');
      const lightCSS = await inlineFont('Madani Arabic Light', 'fonts/MadaniArabic-Light.ttf');
      const styleElement = document.createElementNS("http://www.w3.org/2000/svg", "style");
      styleElement.setAttribute("type", "text/css");
      styleElement.innerHTML = boldCSS + lightCSS;
      svgElement.insertBefore(styleElement, svgElement.firstChild);
    }

    // تحضير نسخة من الـ SVG مع دمج الأنماط والصور والخطوط الخارجية
    async function prepareSVGClone(svgElement) {
      const clone = svgElement.cloneNode(true);
      inlineAllComputedStyles(clone);
      await inlineExternalImages(clone);
      await inlineFonts(clone);
      return clone;
    }

    // حفظ التصميم كصورة PNG بنفس الأبعاد الأصلية (1080×1920)
    async function downloadImage() {
      const svg = document.getElementById("invitationSvg");
      const preparedSVG = await prepareSVGClone(svg);
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(preparedSVG);
      const img = new Image();
      const canvas = document.createElement("canvas");
      canvas.width = 1080;
      canvas.height = 1920;
      const ctx = canvas.getContext("2d");
      img.onload = function() {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const pngData = canvas.toDataURL("image/png");
        const fileName = getFileName() + ".png";
        const downloadLink = document.createElement("a");
        downloadLink.href = pngData;
        downloadLink.download = fileName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      };
      // تحويل الـ SVG إلى base64 وتعيينه لمصدر الصورة
      img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
    }
  </script>
</body>
</html>
